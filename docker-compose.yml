services:
  # Python Task Poller (processes transcription tasks from database)
  transcribe-poller:
    build:
      context: ./python
      dockerfile: Dockerfile
    command: python task_poller.py
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-cpu}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}
      - WHISPER_CPU_THREADS=${WHISPER_CPU_THREADS:-2}
      - MAX_CONCURRENT_TASKS=${MAX_CONCURRENT_TASKS:-6}
      - MAX_SEGMENT_DURATION=${MAX_SEGMENT_DURATION:-900}
      - UPLOAD_DIR=/app/uploads
      - POLL_INTERVAL=2
    volumes:
      - whisper-cache:/root/.cache/huggingface
      - upload-files:/app/uploads
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # Next.js Web App
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - upload-files:/app/uploads
    restart: unless-stopped

volumes:
  whisper-cache:
    driver: local
  upload-files:
    driver: local
